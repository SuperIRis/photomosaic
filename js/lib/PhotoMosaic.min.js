;"use strict";
function PhotoMosaic(t,e,s,i){this.settings={},this.settings.opacity=.8,this.settings.showSpeed=20,this.settings.showSmoothness=.2,this.settings.maskColor="black",this.settings.randomPhotos=!0
for(var o in i)this.settings[o]=i[o]
this.photosURLs=t,this.backgroundImageURL=e,this.backgroundImageObject=new Image,this.canvasId=s,this.canvas=document.getElementById(s),this.rasterCollection=[],this.elementsToSwap=[],this.maskRectangles=[],this.missingPhotos=[],this.rasters=[],this.loadImages()}PhotoMosaic.prototype.onImageLoaded=function(){this.photosLoaded++,this.checkIfPhotosLoaded()},PhotoMosaic.prototype.onImageError=function(t){this.photosLoaded++,this.missingPhotos.push(t),this.checkIfPhotosLoaded()},PhotoMosaic.prototype.loadImages=function(){var t,e=this
this.photosLoaded=0,this.photos=[]
for(var s=0,i=this.photosURLs.length;i>s;s++)t=new Image,t.onload=function(t){return function(){e.onImageLoaded(t)}}(s),t.onerror=function(t){return function(){e.onImageError(t)}}(s),t.src=this.photosURLs[this.photos.length],this.photos.push(t)},PhotoMosaic.prototype.checkIfPhotosLoaded=function(){var t=this
if(this.photosLoaded==this.photosURLs.length){if(this.missingPhotos.length>0)for(var e=0,s=this.missingPhotos.length;s>e;e++)this.photos.splice(this.missingPhotos[e]-e,1)
this.backgroundImageObject.onload=function(){var e=Math.ceil(t.backgroundImageObject.width/t.photos[0].width),s=Math.ceil(t.backgroundImageObject.height/t.photos[0].height),i=e*s
if(i<t.photos.length)t.photos.slice(i-1,i-t.photos.length)
else if(i>t.photos.length){for(var o=0;i>t.photos.length;)o<t.photos.length?(t.photos.push(t.photos[o]),o++):o=0
t.photos.sort(function(){return.5-Math.random()})}t.initialSetup()},this.backgroundImageObject.onerror=function(){console.error("Background image URL is invalid")},this.backgroundImageObject.src=this.backgroundImageURL}},PhotoMosaic.prototype.initialSetup=function(){var t=this
paper.setup(this.canvas),this.baseLayer=new paper.Layer,this.background=new paper.Raster(this.backgroundImageURL),this.background.onLoad=function(){t.backgroundSetup()}},PhotoMosaic.prototype.backgroundSetup=function(){var t,e,s,i=this,o=0,h=0,n=1
this.baseWidth=this.canvas.offsetWidth>this.background.width?this.background.width:this.canvas.offsetWidth,o=Math.floor(this.baseWidth/this.photos[0].width)*this.photos[0].width,n=o/this.baseWidth,h=Math.floor(this.background.height*n),h=Math.floor(h/i.photos[0].height)*i.photos[0].height,s=new paper.Path.Rectangle({point:new paper.Point(0,0),size:[o,h]}),this.background.position=this.canvas.offsetWidth<this.background.width?new paper.Point(this.canvas.offsetWidth/2,this.background.height*n/2):new paper.Point(this.background.width*n/2,this.background.height*n/2),e=new paper.Group([s,this.background]),e.clipped=!0,t=this.canvas.offsetWidth-o,t=this.canvas.offsetWidth/2-t/2,this.canvas.style.marginLeft="-"+t+"px",this.createMask()},PhotoMosaic.prototype.setPhotos=function(){var t=this,e=0,s=0
this.photoLayer=new paper.Layer
for(var i=0,o=this.photos.length;o>i;i++){if(e+this.photos[i].width>this.background.parent.firstChild.bounds.width){if(e=this.photos[i].width/2,s+=this.photos[i].height,s>this.background.parent.firstChild.bounds.height)break}else 0==i?(e=this.photos[i].width/2,s=this.photos[i].height/2):e+=this.photos[i].width
this.rasters[i]=new paper.Raster(this.photos[i]),this.rasters[i].blendMode="overlay",this.rasters[i].position=new paper.Point(e,s)}this.totalPhotos=this.rasters.length,this.background.opacity=this.settings.opacity,this.flatten(),this.maskLayer.activate(),paper.view.draw(),paper.view.onFrame=function(){t.showPhotos()}},PhotoMosaic.prototype.flatten=function(){this.flattened&&(this.flattened.remove(),this.flattened=null),this.flattened=this.photoLayer.rasterize(),this.photoLayer.visible=!1,this.flattened.blendMode="overlay",this.baseLayer.addChild(this.flattened)},PhotoMosaic.prototype.unflatten=function(){this.flattened&&(this.flattened.remove(),this.flattened=null),this.photoLayer.visible=!0},PhotoMosaic.prototype.createMask=function(){var t=this,e=0,s=0
this.maskLayer=new paper.Layer
for(var i=0,o=this.photos.length;o>i;i++){if(e+2*this.photos[i].width>this.baseWidth){if(e=0,s+=this.photos[i].height,s+this.photos[i].height>this.background.height)break}else 0==i?(e=0,s=0):e+=this.photos[i].width
this.maskRectangles.push(new paper.Path.Rectangle({point:[e,s],size:[this.photos[i].width+1,this.photos[i].height+1],fillColor:this.settings.maskColor}))}paper.view.draw(),setTimeout(function(){t.setPhotos()},100)},PhotoMosaic.prototype.showPhotos=function(){if(void 0===this.goneRectangles)for(this.goneRectangles=[],this.i=0;this.i<this.settings.showSpeed;this.i++)this.tempIndex=Math.round(Math.random()*this.maskRectangles.length),this.goneRectangles.push(this.maskRectangles[this.tempIndex]),this.maskRectangles.splice(this.tempIndex,1)
if(this.maskRectangles.length<=0&&this.goneRectangles.length<=0)return paper.view.onFrame=null,void this.finalSetup()
if(this.goneRectangles.length<this.settings.showSpeed&&this.maskRectangles.length>0)for(this.i=0;this.i<this.settings.showSpeed-this.goneRectangles.length;this.i++)this.maskRectangles.length>0&&(this.tempIndex=Math.round(Math.random()*this.maskRectangles.length),this.goneRectangles.push(this.maskRectangles[this.tempIndex]),this.maskRectangles.splice(this.tempIndex,1))
for(this.limit=this.goneRectangles.length,this.i=0;this.i<this.limit;this.i++)void 0!=this.goneRectangles[this.i]&&(this.goneRectangles[this.i].opacity-=this.settings.showSmoothness,this.goneRectangles[this.i].opacity<=.1&&(this.goneRectangles[this.i].opacity=0,this.goneRectangles[this.i].visible=!1,this.limit--))
for(this.limit=this.goneRectangles.length,this.i=0;this.i<this.limit;this.i++)(void 0==this.goneRectangles[this.i]||0==this.goneRectangles[this.i].opacity)&&this.goneRectangles.splice(this.i,1)},PhotoMosaic.prototype.finalSetup=function(){if(this.unflatten(),document.createEventObject){var t=document.createEventObject()
return this.canvas.fireEvent("onComplete")}var t=document.createEvent("HTMLEvents")
return t.initEvent("onComplete",!0,!0),!this.canvas.dispatchEvent(t)},PhotoMosaic.prototype.updateItem=function(t,e){var s,i=this
return this.rasters[t]?(s=new Image,s.onload=function(){i.elementsToSwap.push({index:i.elementsToSwap.length-1,photoIndex:t,shown:!1,imageObject:s}),paper.view.onFrame||(paper.view.onFrame=function(){i.swapElement()})},s.onerror=function(){console.error("The image supplied can't load")},void(s.src=e)):void console.error("There's no item at update index "+t,this.rasters.length)},PhotoMosaic.prototype.swapElement=function(){if(0==this.elementsToSwap.length)return void(paper.view.onFrame=null)
for(var t=0,e=this.elementsToSwap.length;e>t;t++)this.elementsToSwap[t].finish||(this.maskLayer.children[this.elementsToSwap[t].photoIndex].opacity<1&&!this.elementsToSwap[t].shown?(this.maskLayer.children[this.elementsToSwap[t].photoIndex].visible=!0,this.maskLayer.children[this.elementsToSwap[t].photoIndex].opacity+=.1):this.maskLayer.children[this.elementsToSwap[t].photoIndex].opacity>=.9&&!this.elementsToSwap[t].shown?(this.maskLayer.children[this.elementsToSwap[t].photoIndex].opacity=1,this.rasters[this.elementsToSwap[t].photoIndex].setImage(this.elementsToSwap[t].imageObject),this.elementsToSwap[t].shown=!0):this.maskLayer.children[this.elementsToSwap[t].photoIndex].opacity>.1&&this.elementsToSwap[t].shown?this.maskLayer.children[this.elementsToSwap[t].photoIndex].opacity-=.1:this.maskLayer.children[this.elementsToSwap[t].photoIndex].opacity<=.1&&this.elementsToSwap[t].shown&&(this.maskLayer.children[this.elementsToSwap[t].photoIndex].opacity=0,this.maskLayer.children[this.elementsToSwap[t].photoIndex].visible=!1,this.elementsToSwap[t].finish=!0))
for(t=0;e>t;t++)this.elementsToSwap[t].finish&&(this.elementsToSwap.splice(t,1),t++,e--)}
